<!DOCTYPE html>
<html lang='en' data-ng-app="assembla">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Assembla Extension">
    <meta name="author" content="Eric Griffith">

    <title>Assembla API Extension</title>

	<!-- Cascading Style Sheets -->
	<link href="css/bootstrap.css" rel="stylesheet" media="screen">
	<link href="css/font-awesome.min.css" rel="stylesheet" media="screen">
	<link href="assembla.css" rel="stylesheet" media="screen">
  </head>
  <body data-ng-controller="assemblaController as vm">
		<div pageslide ps-side="left" ps-open="vm.showTools" ps-auto-close="true" ps-class="panel"  style="background-color:whitesmoke">
			<div class="container-fluid">
				<div class="row">
					<br/>
					<button type="button" class="close pull-right" ng-click="vm.showTools=!vm.showTools">
						<span>&times;&nbsp;&nbsp;</span>
					</button>
					<div class="col-md-12 text-center">
						<h2>Tools</h2>
					</div>
				</div>
				<br/>
				<div class="row">
					<div class="col-md-10 col-md-offset-2">
						<span class="btn btn-default" ng-click="vm.resetCounts()"
							title="recalculate how many of each type of ticket">Update Ticket Counts</span>
						<strong><span class='fa fa-check text-success' ng-if="vm.resetSuccess"></span></strong>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<div class="input-group">
							<input type="date" class="form-control" ng-model="vm.downloadTicketsSince">
							<div class="input-group-btn">
								<button class="btn btn-default" 
											title="Download and add/merge all tickets since the entered date"
											ng-click="vm.getUpdatedTickets(vm.downloadTicketsSince)">
									<span class="fa fa-download"></span>
								</button>
							</div>
						</div>
					</div>
				</div>				
				<br/>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<button class="btn btn-default" title="Update the selected reference entities from the API"
								ng-click="vm.updateRelatedEntities(vm.entityUpdateObj)">
							Update References
						</button>
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.spaces || vm.entityUpdateObj.spaces===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.spaces==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.spaces==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.spaces==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.spaces" ng-init="true">
						Spaces
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.milestones || vm.entityUpdateObj.milestones===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.milestones==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.milestones==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.milestones==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.milestones" ng-init="true">
						Milestones
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.users || vm.entityUpdateObj.users===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.users==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.users==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.users==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.users" ng-init="true">
						Users
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.customFields || vm.entityUpdateObj.customFields===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.customFields==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.customFields==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.customFields==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.customFields" ng-init="true">
						Custom Fields
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.statuses || vm.entityUpdateObj.statuses===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.statuses==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.statuses==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.statuses==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.statuses" ng-init="true">
						Statuses
					</div>
				</div>
				<div class="row">
					<div class="col-md-8 col-md-offset-2">
						<span>
							<span class="fa fa-spinner invisible" ng-if="!vm.entityUpdateObj.tags || vm.entityUpdateObj.tags===true"></span>
							<span class="fa fa-spinner fa-spin" ng-if="vm.entityUpdateObj.tags==vm._fetchingText"></span>
							<span class="fa fa-check text-success" ng-if="vm.entityUpdateObj.tags==vm._successText"></span>
							<span class="fa fa-exclamation text-danger" ng-if="vm.entityUpdateObj.tags==vm._failureText"></span>
						</span>
						<input type='checkbox' ng-model="vm.entityUpdateObj.tags" ng-init="true">
						Tags
					</div>
				</div>
				
			</div>
		</div>
    <div class="container">
			<div class="row">
				<div id="main" class="col-md-12">
					<div class="row" id="heading">
						<div class="col-md-6">
							<h1>{{vm.data.selectedSpace.name}}</h1>
						</div>
						<div class="col-md-offset-5 col-md-1" style="vertical-align:middle;">
							<br/>
							<button class="btn btn-default" ng-click="vm.showTools=!vm.showTools">
								<span class="hover-icon fa fa-sliders text-muted"></span>
							</button>
						</div>
					</div>
					<div class='row' id='paginationRow'>
						<div class="col-md-2" id="perPage">
							<div class="input-group">
								<input type='number' class="form-control" ng-model-options="{debounce:1000}" ng-change="vm.optionChange()" ng-model="vm.options.itemsPerPage" />
								<span class='input-group-addon'><span class="fa fa-ticket"></span>/p</span>
							</div>
						</div>
						<div class="col-md-7" id="pagination">
							<pagination total-items="filteredTickets.length" ng-model="vm.page" max-size='8'
													boundary-links="true" items-per-page="vm.options.itemsPerPage" rotate="true">
							</pagination>
						</div>
						<div class="col-md-3" id="ticketCount">
							ticket count: 
							<span data-ng-if="filteredTickets.length!=vm.data.tickets.length">
								<span class="badge">{{filteredTickets.length}}</span> 
								of 
							</span>
							<span class="badge">{{vm.data.tickets.length}}</span>
						</div>
					</div>
					<div ng-include="!vm.selectedTickets || vm.selectedTickets.length==0 
															? 'assembla_filterDiv.html'
															: 'assembla_updateDiv.html'"></div>
					<div class="row" id="ticketstable" >
						<div class="col-md-12">
							<table class="table" ng-hide="vm.data.tickets.length==0">
								<tbody>
									<tr>
										<th></th>
										<th ng-click="vm.sort('number')">
											Number <span class="text-muted" ng-class="vm.sortClasses['number']"></span>
										</th>
										<th></th>
										<th>
											Summary
											&nbsp;
											<span class="dropdown" dropdown id="summarySettings">
												<span class="dropdown-toggle" dropdown-toggle>
													<span class="fa fa-gear hover-icon" title="Set summary abbreviation options"></span>
												</span>
												<div class="dropdown-menu list-group" style="left:-50px;"
														ng-style="{'width':vm.options.summaryOptions.isTruncated?300:100}">
														<form class="form form-inline" prevent-default> 
																<label>&nbsp; &nbsp; Abbreviate: </label>
																<strong><span prevent-default	class="fa fa-2x" style="position: relative;top:4px;"
																	ng-class="{'fa-toggle-on':vm.options.summaryOptions.isTruncated,
																						'fa-toggle-off':!vm.options.summaryOptions.isTruncated,
																						'text-success':vm.options.summaryOptions.isTruncated,
																						'text-muted':!vm.options.summaryOptions.isTruncated}"
																		ng-click="vm.options.summaryOptions.isTruncated=!vm.options.summaryOptions.isTruncated" >
																</span></strong>
																&nbsp;
																<input type="number" style="width:60px" title="Number of characters before the ellipsis"
																	ng-model-options="{debounce:500}"
																	ng-if="vm.options.summaryOptions.isTruncated"
																	ng-model="vm.options.summaryOptions.startLength">
																<input type="number" style="width:60px" title="Number of characters after the ellipsis"
																	ng-model-options="{debounce:500}"
																	ng-if="vm.options.summaryOptions.isTruncated"
																	ng-model="vm.options.summaryOptions.endLength">
														</span>
												</div>		
											</span>

										</th>
										<th ng-if="!vm.options.hiddenColumns['Status']" ng-click="vm.sort('status')">
											Status <span class="text-muted" ng-class="vm.sortClasses['status']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Created']" ng-click="vm.sort('created_on')">
											Created <span class="text-muted" ng-class="vm.sortClasses['created_on']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Updated']" ng-click="vm.sort('updated_at')">
											Updated <span class="text-muted" ng-class="vm.sortClasses['updated_at']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Dev']" ng-click="vm.sort('assigned_to_id')">
											Dev <span class="text-muted" ng-class="vm.sortClasses['assigned_to_id']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Milestone']" ng-click="vm.sort('milestone')">
											M'stone <span class="text-muted" ng-class="vm.sortClasses['milestone']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['QA By']" ng-click="vm.sort('custom_fields.QA Assigned Person')">
											QA&nbsp;By <span class="text-muted" ng-class="vm.sortClasses['custom_fields.QA Assigned Person']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['QA']" ng-click="vm.sort('custom_fields.QA')">
											QA <span class="text-muted" ng-class="vm.sortClasses['custom_fields.QA']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Component']" ng-click="vm.sort('custom_fields.Component')">
											Component <span class="text-muted" ng-class="vm.sortClasses['custom_fields.Component']"></span>
										</th>
										<th ng-if="!vm.options.hiddenColumns['Desc?']">
											Desc?
										</th>
										<th>
											<span class="dropdown" dropdown id="columnSettings">
												<span class="dropdown-toggle" dropdown-toggle>
													<span class="fa fa-gear hover-icon" title="Choose columns to show/hide"></span>
												</span>
												<div class="dropdown-menu list-group text-center" style="left:-300px; width:550px">
														&nbsp;
														<span ng-repeat="(ck,isHidden) in vm.options.hiddenColumns"> 
																<span class="label" prevent-default	ng-class="{'label-success':!isHidden,'label-default':isHidden}"
																ng-click="vm.options.hiddenColumns[ck]=!vm.options.hiddenColumns[ck]; vm.optionChange()" >
																	{{ck}}
																</span>
																&nbsp;
														</span>
												</div>		
											</span>
										</th>

									</tr>
									<tr ng-class="{'bg-success': t.updateSuccess,'bg-danger': t.updateFailure}"
											data-ng-repeat-start="t in filteredTickets = (
											vm.data.tickets	| filter: vm.filterTickets) 
																			| startFrom: (vm.page-1) * vm.options.itemsPerPage
																			| limitTo: vm.options.itemsPerPage">
										<td data-ng-click="vm.toggle(t,'expanded')">
											<span class="glyphicon" data-ng-class="{'glyphicon-minus':t.expanded, 'glyphicon-plus':!t.expanded}"></span>
										</td>
										<td class="text-center" >{{::t.number}}</td>
										<td>
											<span class="fa fa-edit hover-icon"
													ng-style="{'color':vm.selectedTickets.indexOf(t)>-1?'green':'lightgrey'}"
													ng-click="vm.toggleTicketSelected(t)" >
											</span>
										</td>
										<td ng-if="vm.options.summaryOptions.isTruncated" title="{{::t.summary}}">
											{{::vm.abbreviate(t.summary,
														vm.options.summaryOptions.startLength,vm.options.summaryOptions.endLength)}}
										</td>
										<td ng-if="!vm.options.summaryOptions.isTruncated">
											{{::t.summary}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Status']">
													{{t.status}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Created']">
											{{::t.created_on | date:'dd&nbsp;MMM&nbsp;yy'}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Updated']">
											{{::t.updated_at | date:'dd&nbsp;MMM&nbsp;yy'}}
										</td>
										<td  ng-if="!vm.options.hiddenColumns['Dev']"
												title="{{vm.data.users[t.assigned_to_id].login}}">
													{{vm.data.users[t.assigned_to_id].initials || '--'}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Milestone']" 
												title="{{vm.data.milestones[t.milestone_id].title}}">
													{{vm.data.milestones[t.milestone_id].initials || '--'}}
										</td>
										<td  ng-if="!vm.options.hiddenColumns['QA By']"
												title="{{t.custom_fields['QA Assigned Person']}}">
													{{vm.getInitials(t.custom_fields['QA Assigned Person'] || '--')}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['QA']">
											{{t.custom_fields['QA']}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Component']">
											{{t.custom_fields['Component']}}
										</td>
										<td ng-if="!vm.options.hiddenColumns['Desc?']" ><span class="glyphicon" data-ng-click="vm.parseDescription(t)"
												data-ng-class="{'glyphicon-ok': vm.isValidTicket(t), 'glyphicon-remove': !vm.isValidTicket(t), 
																		'text-success': vm.isValidTicket(t), 'text-danger': !vm.isValidTicket(t)}">
												</span>
										</td>
										<td>
											<span class="dropdown" dropdown>
												<span class="fa fa-comments-o icon-badgeable hover-icon dropdown-toggle" dropdown-toggle 
													title="Retrieve comments">
													<span class="icon-badge">{{t.comments.comments.length}}</span>
												</span>
												<span class="list-group dropdown-menu">
													<a href class="list-group-item" ng-click="vm.getComments(t.number)">Refresh Comments</a>
													<a href class="list-group-item" ng-click="vm.addComment(t.number)">Add a Comment</a>
													<a href class="list-group-item" ng-click="vm.viewComments(t.number)">View Comments</a>
												</span>
											</span>
										</td>
									</tr>
									<tr data-ng-if="t.expanded" data-ng-repeat-end>
										<td></td>
										<td colspan="6">
											<span click-to-edit="t.description" test="'testVal'" 
														on-value-change="vm.updateTicket" value-change-parms="[t,'description','@newVal','@oldVal']"></click-to-edit>
										</td> 
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	    <!-- Scripts -->
		<script src="js/jquery-2.0.3.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
    <script src="js/angular.min.js" charset="utf-8"></script>
    <script src="js/angular-pageslide-directive.min.js" charset="utf-8"></script>
    <script src="js/localforage.js" charset="utf-8"></script>
    <script src="js/angular-localForage.js" charset="utf-8"></script>
    <script src="js/ui-bootstrap-tpls-0.12.1.min.js" charset="utf-8"></script>
    <script src="ngDirectiveModule.js" charset="utf-8"></script>
    <script src="assembla.js" charset="utf-8"></script>
    <script src="assemblaService.js" charset="utf-8"></script>
    <script src="assemblaPersistenceService.js" charset="utf-8"></script>

  </body>
</html>
